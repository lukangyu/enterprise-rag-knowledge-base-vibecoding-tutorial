# 4.5阶段开发计划 - 检索与问答模块完善

> 创建日期: 2026-02-19
> 状态: 待确认
> 依据文档: 05-开发计划文档.md

---

## 一、开发背景

根据前期项目分析，4.5阶段（检索与问答模块）当前完成率约为67.9%，存在以下未完成项：

### 已完成部分 ✅
- 混合检索服务（Milvus向量检索、ES关键词检索、RRF融合）
- 图遍历检索服务（BFS/DFS遍历、多跳查询、证据链构建）
- 基础融合重排（RRF融合、加权融合）

### 未完成部分 ❌
1. **LLM问答服务** - 缺少上下文构建、SSE流式输出、引用标注
2. **Qwen-Reranker集成** - 重排序服务未实现
3. **前端问答界面** - React项目未创建

---

## 二、开发目标

完成4.5阶段所有未完成任务，实现完整的GraphRAG问答流程：

```
用户提问 → 向量检索 → 图遍历检索 → 融合重排 → LLM生成 → 流式输出 → 引用标注
```

---

## 三、开发任务清单

### 3.1 LLM问答服务完善（FastAPI）

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T5.4.2 | 上下文构建服务 | 1天 | P0 | ContextBuilder类 |
| T5.4.4 | SSE流式输出 | 1天 | P0 | SSEStreamHandler类 |
| T5.4.5 | 引用标注服务 | 1天 | P1 | ReferenceAnnotator类 |
| T5.4.1 | 问答Prompt模板 | 0.5天 | P1 | QAPromptTemplate类 |

**技术要点：**
- 上下文构建：将检索结果转换为LLM可理解的上下文格式
- SSE流式输出：使用FastAPI StreamingResponse实现
- 引用标注：在回答中标注来源文档和片段

### 3.2 融合重排服务完善（FastAPI）

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T5.3.4 | Qwen-Reranker集成 | 1天 | P1 | RerankerService类 |

**技术要点：**
- 集成Qwen-Reranker API进行二次重排序
- 支持配置重排序阈值和Top-K参数

### 3.3 前端问答界面开发（React）

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T5.5.1 | React项目初始化 | 1天 | P0 | 前端项目骨架 |
| T5.5.2 | 对话界面组件 | 2天 | P0 | ChatInterface组件 |
| T5.5.3 | 流式输出展示 | 1天 | P0 | StreamOutput组件 |
| T5.5.4 | 引用来源展示 | 1天 | P1 | ReferenceList组件 |
| T5.5.5 | 证据链可视化 | 1天 | P2 | EvidenceChainView组件 |

**技术栈：**
- React 18 + TypeScript 5
- Ant Design Pro 6.x
- Vite 5.x
- SSE客户端实现

---

## 四、详细开发计划

### Phase 1: 后端LLM问答服务（第1-2周）

#### 4.1.1 上下文构建服务

**文件位置：** `backend/ai-services/services/qa/context_builder.py`

**功能设计：**
```python
class ContextBuilder:
    """上下文构建服务"""
    
    def build_context(
        self,
        query: str,
        search_results: List[Dict],
        graph_context: Optional[Dict] = None,
        max_tokens: int = 4000
    ) -> str:
        """构建LLM上下文"""
        pass
    
    def format_search_results(self, results: List[Dict]) -> str:
        """格式化检索结果"""
        pass
    
    def format_graph_context(self, graph_data: Dict) -> str:
        """格式化图谱上下文"""
        pass
```

#### 4.1.2 SSE流式输出服务

**文件位置：** `backend/ai-services/services/qa/stream_handler.py`

**功能设计：**
```python
class SSEStreamHandler:
    """SSE流式输出处理"""
    
    async def stream_generate(
        self,
        query: str,
        context: str,
        model: str = "qwen-max"
    ) -> AsyncGenerator[str, None]:
        """流式生成回答"""
        pass
```

**API端点：** `backend/ai-services/api/qa.py`
```python
@router.post("/chat/stream")
async def chat_stream(request: ChatRequest):
    """流式问答接口"""
    return StreamingResponse(
        stream_handler.stream_generate(...),
        media_type="text/event-stream"
    )
```

#### 4.1.3 引用标注服务

**文件位置：** `backend/ai-services/services/qa/reference_annotator.py`

**功能设计：**
```python
class ReferenceAnnotator:
    """引用标注服务"""
    
    def annotate_response(
        self,
        response: str,
        sources: List[Dict]
    ) -> AnnotatedResponse:
        """标注回答中的引用来源"""
        pass
```

#### 4.1.4 问答Prompt模板

**文件位置：** `backend/ai-services/services/qa/prompt_template.py`

**模板设计：**
```python
QA_PROMPT_TEMPLATE = """
你是一个专业的知识库问答助手。请根据以下上下文回答用户问题。

## 上下文信息
{context}

## 用户问题
{query}

## 回答要求
1. 基于上下文信息准确回答
2. 如果上下文中没有相关信息，请明确说明
3. 在回答中标注引用来源，格式为 [来源ID]
4. 回答要简洁、准确、有条理

## 回答
"""
```

### Phase 2: Qwen-Reranker集成（第2周）

**文件位置：** `backend/ai-services/services/search/reranker.py`

**功能设计：**
```python
class RerankerService:
    """Qwen-Reranker重排序服务"""
    
    def __init__(self):
        self.api_url = settings.RERANKER_API_URL
        self.api_key = settings.RERANKER_API_KEY
    
    async def rerank(
        self,
        query: str,
        documents: List[Dict],
        top_k: int = 10
    ) -> List[Dict]:
        """重排序文档"""
        pass
```

### Phase 3: 前端问答界面（第2-3周）

#### 4.3.1 项目结构

```
frontend/
├── src/
│   ├── api/
│   │   ├── chat.ts          # 问答API
│   │   └── stream.ts        # SSE流式处理
│   ├── components/
│   │   ├── ChatInterface/
│   │   │   ├── index.tsx
│   │   │   ├── MessageList.tsx
│   │   │   ├── InputBox.tsx
│   │   │   └── styles.module.css
│   │   ├── StreamOutput/
│   │   │   └── index.tsx
│   │   ├── ReferenceList/
│   │   │   └── index.tsx
│   │   └── EvidenceChainView/
│   │       └── index.tsx
│   ├── pages/
│   │   └── Chat/
│   │       └── index.tsx
│   ├── hooks/
│   │   └── useSSE.ts
│   ├── stores/
│   │   └── chatStore.ts
│   └── App.tsx
├── package.json
├── vite.config.ts
└── tsconfig.json
```

#### 4.3.2 核心组件设计

**ChatInterface组件：**
```tsx
// 对话界面主组件
const ChatInterface: React.FC = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  
  const handleSend = async (query: string) => {
    // 发送消息并处理SSE流式响应
  };
  
  return (
    <div className="chat-container">
      <MessageList messages={messages} />
      <InputBox onSend={handleSend} disabled={isLoading} />
    </div>
  );
};
```

**SSE流式处理Hook：**
```tsx
// useSSE.ts
const useSSE = (url: string) => {
  const [data, setData] = useState<string>('');
  const [isStreaming, setIsStreaming] = useState(false);
  
  const connect = useCallback(() => {
    const eventSource = new EventSource(url);
    eventSource.onmessage = (event) => {
      setData(prev => prev + event.data);
    };
    // ...
  }, [url]);
  
  return { data, isStreaming, connect };
};
```

---

## 五、文件创建清单

### 后端文件（FastAPI）

| 文件路径 | 说明 |
|---------|------|
| `backend/ai-services/services/qa/__init__.py` | QA服务模块初始化 |
| `backend/ai-services/services/qa/context_builder.py` | 上下文构建服务 |
| `backend/ai-services/services/qa/stream_handler.py` | SSE流式输出处理 |
| `backend/ai-services/services/qa/reference_annotator.py` | 引用标注服务 |
| `backend/ai-services/services/qa/prompt_template.py` | Prompt模板 |
| `backend/ai-services/services/search/reranker.py` | Reranker服务 |
| `backend/ai-services/api/qa.py` | 问答API端点 |
| `backend/ai-services/models/qa_models.py` | 问答数据模型 |
| `backend/ai-services/tests/test_qa.py` | 问答服务测试 |

### 前端文件（React）

| 文件路径 | 说明 |
|---------|------|
| `frontend/package.json` | 项目依赖配置 |
| `frontend/vite.config.ts` | Vite配置 |
| `frontend/tsconfig.json` | TypeScript配置 |
| `frontend/src/main.tsx` | 入口文件 |
| `frontend/src/App.tsx` | 应用主组件 |
| `frontend/src/api/chat.ts` | 问答API |
| `frontend/src/api/stream.ts` | SSE流式处理 |
| `frontend/src/components/ChatInterface/index.tsx` | 对话界面 |
| `frontend/src/components/StreamOutput/index.tsx` | 流式输出展示 |
| `frontend/src/components/ReferenceList/index.tsx` | 引用来源展示 |
| `frontend/src/components/EvidenceChainView/index.tsx` | 证据链可视化 |
| `frontend/src/hooks/useSSE.ts` | SSE Hook |
| `frontend/src/stores/chatStore.ts` | 状态管理 |

---

## 六、开发时间线

```
Week 1:
├── Day 1-2: 上下文构建服务 + Prompt模板
├── Day 3-4: SSE流式输出服务
└── Day 5: 引用标注服务

Week 2:
├── Day 1: Qwen-Reranker集成
├── Day 2: 前端项目初始化
├── Day 3-4: 对话界面组件
└── Day 5: 流式输出展示

Week 3:
├── Day 1-2: 引用来源展示 + 证据链可视化
├── Day 3: 集成测试
└── Day 4-5: 优化与文档
```

---

## 七、验收标准

### 功能验收

| 功能 | 验收标准 |
|------|---------|
| 上下文构建 | 检索结果正确转换为LLM上下文 |
| SSE流式输出 | 首字延迟<500ms，支持流式展示 |
| 引用标注 | 回答中正确标注来源文档 |
| Reranker | 重排序后Top-10准确率提升>5% |
| 前端对话界面 | 可完成完整问答流程 |
| 流式展示 | 实时显示LLM生成内容 |
| 引用展示 | 点击引用可跳转原文 |

### 性能验收

| 指标 | 目标值 |
|------|--------|
| 问答响应时间 | < 3秒 |
| 首字延迟 | < 500ms |
| 流式输出延迟 | < 100ms/chunk |
| 前端首屏加载 | < 2秒 |

---

## 八、风险与应对

| 风险 | 等级 | 应对措施 |
|------|------|---------|
| LLM API不稳定 | 高 | 实现重试机制和降级策略 |
| SSE兼容性问题 | 中 | 提供轮询降级方案 |
| 前端开发进度 | 中 | 优先核心功能，后续迭代优化 |

---

## 九、依赖关系

```
上下文构建 ──→ SSE流式输出 ──→ 前端流式展示
      │
      └──→ 引用标注 ──→ 前端引用展示
      
Reranker ──→ 融合重排优化

前端项目初始化 ──→ 对话界面 ──→ 流式展示 ──→ 引用展示
```

---

## 十、执行确认

本计划完成后，4.5阶段将达到100%完成率，实现完整的GraphRAG问答功能。
