# 4.6阶段开发计划 - 系统管理与优化

> 创建日期: 2026-02-19
> 状态: 待确认
> 依据文档: 05-开发计划文档.md、04-API接口设计文档.md

---

## 一、开发背景

4.6阶段是项目最后一个开发阶段，主要完成系统管理功能、前端管理后台、性能优化及测试文档工作。

### 当前状态分析

| 模块 | 现有基础 | 需要开发 |
|------|---------|---------|
| 系统配置管理 | settings.py基础配置 | 动态配置API、配置持久化 |
| 系统状态监控 | health.py基础健康检查 | 完善监控指标、资源监控 |
| 审计日志 | 无 | 完整审计日志系统 |
| 统计分析 | kg/statistics.py图谱统计 | 全局统计分析API |
| 前端管理后台 | Chat页面 | 用户/文档/配置/仪表盘页面 |
| 缓存优化 | 无 | Redis缓存集成 |
| 测试 | 部分测试用例 | 完善测试覆盖率 |

---

## 二、开发目标

完成4.6阶段所有任务，实现完整的系统管理功能：

```
系统配置 → 状态监控 → 审计日志 → 统计分析 → 前端管理 → 性能优化 → 测试文档
```

---

## 三、开发任务清单

### 3.1 系统管理API（后端FastAPI）

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T6.1.1 | 系统配置管理API | 1天 | P0 | ConfigController |
| T6.1.2 | 系统状态监控API | 1天 | P0 | HealthCheckService |
| T6.1.3 | 审计日志查询API | 1天 | P1 | AuditLogController |
| T6.1.4 | 统计分析API | 1天 | P1 | StatisticsController |

### 3.2 前端管理后台（React）

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T6.2.1 | 用户管理页面 | 1天 | P1 | UserManagement页面 |
| T6.2.2 | 文档管理页面 | 1天 | P0 | DocumentManagement页面 |
| T6.2.3 | 系统配置页面 | 1天 | P1 | SystemConfig页面 |
| T6.2.4 | 统计仪表盘 | 2天 | P0 | Dashboard页面 |

### 3.3 性能优化

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T6.3.1 | Redis缓存优化 | 1天 | P1 | 缓存策略实现 |
| T6.3.2 | 数据库索引优化 | 1天 | P2 | 索引优化脚本 |
| T6.3.3 | 检索性能调优 | 1天 | P1 | Pipeline优化 |
| T6.3.4 | LLM调用优化 | 1天 | P1 | 并发调用优化 |

### 3.4 测试与文档

| 任务ID | 任务名称 | 工期 | 优先级 | 交付物 |
|--------|---------|------|--------|--------|
| T6.4.1 | 单元测试完善 | 2天 | P0 | 测试覆盖率>70% |
| T6.4.2 | 集成测试 | 2天 | P1 | 集成测试用例 |
| T6.4.3 | API文档完善 | 1天 | P1 | OpenAPI文档 |
| T6.4.4 | 部署文档编写 | 1天 | P2 | 部署指南 |

---

## 四、详细开发计划

### Phase 1: 后端系统管理API（第1周）

#### 4.1.1 系统配置管理API

**文件位置：** `backend/ai-services/api/system/config.py`

**功能设计：**
```python
class SystemConfigAPI:
    """系统配置管理API"""
    
    @router.get("/system/config")
    async def get_config():
        """获取系统配置"""
        pass
    
    @router.put("/system/config")
    async def update_config(config: ConfigUpdate):
        """更新系统配置"""
        pass
    
    @router.get("/system/config/{key}")
    async def get_config_value(key: str):
        """获取单个配置项"""
        pass
```

**配置项定义：**
- general: 站点名称、描述、上传限制
- search: 检索参数配置
- llm: LLM模型配置
- kg: 知识图谱配置

#### 4.1.2 系统状态监控API

**文件位置：** `backend/ai-services/api/system/status.py`

**功能设计：**
```python
class SystemStatusAPI:
    """系统状态监控API"""
    
    @router.get("/system/status")
    async def get_status():
        """获取系统状态"""
        pass
    
    @router.get("/system/status/components")
    async def get_component_status():
        """获取组件状态"""
        pass
    
    @router.get("/system/status/resources")
    async def get_resource_usage():
        """获取资源使用情况"""
        pass
```

**监控指标：**
- 组件状态：API网关、业务服务、AI服务、数据库
- 资源使用：CPU、内存、磁盘、GPU
- 统计数据：文档数、实体数、查询数

#### 4.1.3 审计日志API

**文件位置：** `backend/ai-services/api/system/audit.py`

**功能设计：**
```python
class AuditLogAPI:
    """审计日志API"""
    
    @router.get("/system/audit-logs")
    async def list_audit_logs(params: AuditLogQuery):
        """查询审计日志"""
        pass
    
    @router.post("/system/audit-logs")
    async def create_audit_log(log: AuditLogCreate):
        """创建审计日志"""
        pass
```

**审计日志模型：**
```python
class AuditLog(BaseModel):
    id: str
    user_id: str
    username: str
    action: str  # login, create, update, delete, query
    resource_type: str  # document, entity, user, system
    resource_id: Optional[str]
    details: Dict[str, Any]
    ip_address: str
    user_agent: str
    status: str  # success, failed
    created_at: datetime
```

#### 4.1.4 统计分析API

**文件位置：** `backend/ai-services/api/system/statistics.py`

**功能设计：**
```python
class StatisticsAPI:
    """统计分析API"""
    
    @router.get("/system/statistics")
    async def get_statistics(period: str = "7d"):
        """获取统计数据"""
        pass
    
    @router.get("/system/statistics/documents")
    async def get_document_stats():
        """文档统计"""
        pass
    
    @router.get("/system/statistics/queries")
    async def get_query_stats():
        """查询统计"""
        pass
    
    @router.get("/system/statistics/knowledge-graph")
    async def get_kg_stats():
        """知识图谱统计"""
        pass
```

### Phase 2: 前端管理后台（第1-2周）

#### 4.2.1 项目结构扩展

```
frontend/src/
├── api/
│   ├── chat.ts          # 已有
│   ├── system.ts        # 新增：系统管理API
│   └── document.ts      # 新增：文档管理API
├── components/
│   ├── ChatInterface/   # 已有
│   ├── Dashboard/       # 新增：仪表盘组件
│   │   ├── StatCard.tsx
│   │   ├── ChartCard.tsx
│   │   └── index.tsx
│   ├── DocumentTable/   # 新增：文档表格组件
│   └── UserTable/       # 新增：用户表格组件
├── pages/
│   ├── Chat/            # 已有
│   ├── Dashboard/       # 新增：仪表盘页面
│   ├── Documents/       # 新增：文档管理页面
│   ├── Users/           # 新增：用户管理页面
│   └── Settings/        # 新增：系统配置页面
└── stores/
    ├── chatStore.ts     # 已有
    └── systemStore.ts   # 新增：系统状态管理
```

#### 4.2.2 Dashboard页面设计

**文件位置：** `frontend/src/pages/Dashboard/index.tsx`

**功能模块：**
- 统计卡片：文档数、实体数、查询数、用户数
- 图表展示：文档类型分布、查询趋势、实体类型分布
- 系统状态：组件健康状态、资源使用率

#### 4.2.3 文档管理页面设计

**文件位置：** `frontend/src/pages/Documents/index.tsx`

**功能模块：**
- 文档列表：分页、搜索、过滤
- 文档上传：单文件/批量上传
- 文档操作：查看、编辑、删除、重新处理
- 状态查看：处理进度、错误信息

### Phase 3: 性能优化（第2周）

#### 4.3.1 Redis缓存优化

**文件位置：** `backend/ai-services/services/cache/redis_cache.py`

**缓存策略：**
```python
class RedisCache:
    """Redis缓存服务"""
    
    # 缓存配置
    CACHE_TTL = {
        "embedding": 3600,      # 向量缓存1小时
        "search_result": 300,   # 搜索结果缓存5分钟
        "entity": 1800,         # 实体缓存30分钟
        "config": 600,          # 配置缓存10分钟
    }
    
    async def get_embedding(self, text: str) -> Optional[List[float]]:
        """获取缓存的向量"""
        pass
    
    async def set_embedding(self, text: str, embedding: List[float]):
        """缓存向量"""
        pass
    
    async def get_search_result(self, query_hash: str) -> Optional[Dict]:
        """获取缓存的搜索结果"""
        pass
```

#### 4.3.2 检索性能优化

**优化点：**
1. 向量检索：批量查询、结果缓存
2. 图遍历：路径缓存、限制遍历深度
3. 融合排序：并行计算、提前终止

#### 4.3.3 LLM调用优化

**文件位置：** `backend/ai-services/services/qa/llm_pool.py`

**优化策略：**
```python
class LLMPool:
    """LLM连接池"""
    
    def __init__(self, max_connections: int = 10):
        self.semaphore = asyncio.Semaphore(max_connections)
        self.connection_pool = []
    
    async def acquire(self):
        """获取连接"""
        async with self.semaphore:
            return await self._get_connection()
    
    async def batch_generate(self, prompts: List[str]) -> List[str]:
        """批量生成"""
        pass
```

### Phase 4: 测试与文档（第2-3周）

#### 4.4.1 单元测试

**测试文件结构：**
```
backend/ai-services/tests/
├── test_qa.py           # 已有
├── test_system.py       # 新增：系统管理测试
├── test_cache.py        # 新增：缓存测试
├── test_statistics.py   # 新增：统计测试
└── test_audit.py        # 新增：审计日志测试
```

#### 4.4.2 集成测试

**测试场景：**
1. 完整问答流程测试
2. 文档处理流程测试
3. 系统配置更新测试
4. 缓存失效测试

#### 4.4.3 API文档

**OpenAPI规范：**
- 完善所有API端点的描述
- 添加请求/响应示例
- 添加错误码说明

---

## 五、文件创建清单

### 后端文件（FastAPI）

| 文件路径 | 说明 |
|---------|------|
| `backend/ai-services/api/system/__init__.py` | 系统模块初始化 |
| `backend/ai-services/api/system/config.py` | 配置管理API |
| `backend/ai-services/api/system/status.py` | 状态监控API |
| `backend/ai-services/api/system/audit.py` | 审计日志API |
| `backend/ai-services/api/system/statistics.py` | 统计分析API |
| `backend/ai-services/services/cache/__init__.py` | 缓存模块初始化 |
| `backend/ai-services/services/cache/redis_cache.py` | Redis缓存服务 |
| `backend/ai-services/services/audit/__init__.py` | 审计模块初始化 |
| `backend/ai-services/services/audit/audit_service.py` | 审计服务 |
| `backend/ai-services/models/system_models.py` | 系统数据模型 |
| `backend/ai-services/tests/test_system.py` | 系统测试 |
| `backend/ai-services/tests/test_cache.py` | 缓存测试 |

### 前端文件（React）

| 文件路径 | 说明 |
|---------|------|
| `frontend/src/api/system.ts` | 系统管理API |
| `frontend/src/api/document.ts` | 文档管理API |
| `frontend/src/stores/systemStore.ts` | 系统状态管理 |
| `frontend/src/pages/Dashboard/index.tsx` | 仪表盘页面 |
| `frontend/src/pages/Dashboard/Dashboard.css` | 仪表盘样式 |
| `frontend/src/pages/Documents/index.tsx` | 文档管理页面 |
| `frontend/src/pages/Documents/Documents.css` | 文档管理样式 |
| `frontend/src/pages/Users/index.tsx` | 用户管理页面 |
| `frontend/src/pages/Settings/index.tsx` | 系统配置页面 |
| `frontend/src/components/Dashboard/StatCard.tsx` | 统计卡片组件 |
| `frontend/src/components/Dashboard/ChartCard.tsx` | 图表卡片组件 |
| `frontend/src/components/DocumentTable/index.tsx` | 文档表格组件 |

---

## 六、开发时间线

```
Week 1:
├── Day 1: 系统配置管理API + 状态监控API
├── Day 2: 审计日志API + 统计分析API
├── Day 3: 前端Dashboard页面
├── Day 4: 前端文档管理页面
└── Day 5: 前端用户管理 + 系统配置页面

Week 2:
├── Day 1: Redis缓存优化
├── Day 2: 检索性能优化 + LLM调用优化
├── Day 3: 单元测试完善
├── Day 4: 集成测试
└── Day 5: API文档 + 部署文档
```

---

## 七、验收标准

### 功能验收

| 功能 | 验收标准 |
|------|---------|
| 系统配置管理 | 支持动态配置读取和更新 |
| 系统状态监控 | 实时显示组件状态和资源使用 |
| 审计日志 | 完整记录用户操作，支持查询过滤 |
| 统计分析 | 提供多维度统计数据和图表 |
| 前端管理后台 | 完整的管理界面，操作流畅 |
| Redis缓存 | 缓存命中率>80%，响应时间降低>30% |
| 测试覆盖率 | 单元测试覆盖率>70% |

### 性能验收

| 指标 | 目标值 |
|------|--------|
| 系统状态API响应 | < 100ms |
| 统计API响应 | < 500ms |
| 缓存命中率 | > 80% |
| 前端首屏加载 | < 2秒 |

---

## 八、风险与应对

| 风险 | 等级 | 应对措施 |
|------|------|---------|
| Redis依赖 | 中 | 提供内存缓存降级方案 |
| 测试覆盖率 | 中 | 优先核心模块测试 |
| 前端开发进度 | 低 | 复用Ant Design组件 |

---

## 九、依赖关系

```
系统配置API ──→ 前端配置页面
      │
      └──→ 缓存服务

状态监控API ──→ 前端仪表盘
      │
      └──→ 统计分析API

审计日志API ──→ 审计服务

前端Dashboard ──→ 系统状态API + 统计API
前端文档管理 ──→ 文档API
前端用户管理 ──→ 用户API
```

---

## 十、执行确认

本计划完成后，4.6阶段将达到100%完成率，实现完整的系统管理功能，项目可进入交付阶段。
