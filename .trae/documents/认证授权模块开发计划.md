# 认证授权模块开发计划

## 一、模块概述

### 1.1 开发目标
实现企业级GraphRAG知识库系统的认证授权模块，包括JWT认证机制和RBAC权限管理功能。

### 1.2 技术栈
- **Spring Boot 3.2.5** - 基础框架
- **Spring Security 6.x** - 安全框架
- **JJWT 0.12.5** - JWT令牌处理
- **MyBatis Plus 3.5.5** - ORM框架
- **Redis 7.x** - Token缓存
- **PostgreSQL 15+** - 数据持久化

### 1.3 现有基础设施
- 数据库表结构已创建：users, roles, permissions, user_roles, role_permissions
- 默认角色：super_admin, admin, user
- 默认管理员：admin/admin123
- JWT配置已定义：secret, access-token-expire, refresh-token-expire

---

## 二、开发任务分解

### 阶段一：JWT令牌服务 (预计文件数：4)

#### 1.1 JWT配置属性类
**文件路径**: `graphrag-common/src/main/java/com/graphrag/common/security/jwt/JwtProperties.java`
- 读取application.yml中的jwt配置
- 支持动态配置secret、过期时间、issuer

#### 1.2 JWT工具类
**文件路径**: `graphrag-common/src/main/java/com/graphrag/common/security/jwt/JwtTokenProvider.java`
- `generateAccessToken(User user)` - 生成访问令牌
- `generateRefreshToken(User user)` - 生成刷新令牌
- `validateToken(String token)` - 验证令牌有效性
- `parseToken(String token)` - 解析令牌获取Claims
- `getUserIdFromToken(String token)` - 从令牌获取用户ID
- `getUsernameFromToken(String token)` - 从令牌获取用户名
- `isTokenExpired(String token)` - 检查令牌是否过期

#### 1.3 JWT认证过滤器
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/security/JwtAuthenticationFilter.java`
- 继承OncePerRequestFilter
- 从请求头提取Bearer Token
- 验证Token并设置SecurityContext
- 处理Token过期和无效异常

#### 1.4 Token缓存服务
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/service/TokenService.java`
- `storeToken(userId, token)` - 存储Token到Redis
- `getToken(userId)` - 获取缓存的Token
- `removeToken(userId)` - 删除Token（登出）
- `isTokenValid(userId, token)` - 验证Token是否有效（未被撤销）

---

### 阶段二：RBAC实体与数据访问层 (预计文件数：10)

#### 2.1 实体类 (Entity)
**文件路径**: `graphrag-common/src/main/java/com/graphrag/common/security/entity/`

| 文件名 | 说明 |
|--------|------|
| User.java | 用户实体，对应users表 |
| Role.java | 角色实体，对应roles表 |
| Permission.java | 权限实体，对应permissions表 |
| UserRole.java | 用户角色关联实体 |
| RolePermission.java | 角色权限关联实体 |

#### 2.2 Mapper接口
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/mapper/`

| 文件名 | 说明 |
|--------|------|
| UserMapper.java | 用户数据访问，继承BaseMapper |
| RoleMapper.java | 角色数据访问 |
| PermissionMapper.java | 权限数据访问 |
| UserRoleMapper.java | 用户角色关联数据访问 |
| RolePermissionMapper.java | 角色权限关联数据访问 |

#### 2.3 自定义SQL方法
- `UserMapper.selectByUsername(String username)` - 根据用户名查询用户
- `UserMapper.selectUserWithRoles(Long userId)` - 查询用户及其角色
- `RoleMapper.selectRolesByUserId(Long userId)` - 查询用户的角色列表
- `PermissionMapper.selectPermissionsByUserId(Long userId)` - 查询用户的权限列表
- `PermissionMapper.selectPermissionsByRoleId(Long roleId)` - 查询角色的权限列表

---

### 阶段三：用户详情服务 (预计文件数：3)

#### 3.1 登录用户详情类
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/security/LoginUser.java`
- 实现UserDetails接口
- 包含用户基本信息、角色列表、权限列表
- 缓存用户权限数据

#### 3.2 用户详情服务
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/security/UserDetailsServiceImpl.java`
- 实现UserDetailsService接口
- `loadUserByUsername(String username)` - 加载用户详情
- 支持从Redis缓存加载用户权限

#### 3.3 用户权限缓存服务
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/service/UserPermissionCacheService.java`
- `cacheUserPermissions(userId, permissions)` - 缓存用户权限
- `getUserPermissions(userId)` - 获取缓存的用户权限
- `clearUserPermissionCache(userId)` - 清除用户权限缓存
- `refreshUserPermissionCache(userId)` - 刷新用户权限缓存

---

### 阶段四：认证API接口 (预计文件数：6)

#### 4.1 DTO类
**文件路径**: `graphrag-common/src/main/java/com/graphrag/common/security/dto/`

| 文件名 | 说明 |
|--------|------|
| LoginRequest.java | 登录请求DTO |
| LoginResponse.java | 登录响应DTO |
| RegisterRequest.java | 注册请求DTO |
| RefreshTokenRequest.java | 刷新令牌请求DTO |
| UserInfoResponse.java | 用户信息响应DTO |

#### 4.2 认证服务接口与实现
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/service/`

| 文件名 | 说明 |
|--------|------|
| AuthService.java | 认证服务接口 |
| AuthServiceImpl.java | 认证服务实现 |

**核心方法**:
- `login(LoginRequest)` - 用户登录，返回Token
- `register(RegisterRequest)` - 用户注册
- `logout()` - 用户登出
- `refreshToken(RefreshTokenRequest)` - 刷新Token
- `getCurrentUser()` - 获取当前登录用户
- `validateCaptcha(String, String)` - 验证码校验（可选）

#### 4.3 认证控制器
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/controller/AuthController.java`
- `POST /auth/login` - 登录接口
- `POST /auth/register` - 注册接口
- `POST /auth/logout` - 登出接口
- `POST /auth/refresh` - 刷新Token接口
- `GET /auth/me` - 获取当前用户信息

---

### 阶段五：权限校验中间件 (预计文件数：4)

#### 5.1 权限注解
**文件路径**: `graphrag-common/src/main/java/com/graphrag/common/security/annotation/`

| 文件名 | 说明 |
|--------|------|
| RequirePermission.java | 权限校验注解 |
| RequireRole.java | 角色校验注解 |

#### 5.2 权限切面
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/security/PermissionAspect.java`
- 拦截@RequirePermission注解
- 校验用户是否拥有所需权限
- 支持AND/OR逻辑组合

#### 5.3 访问决策管理器
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/security/CustomAccessDecisionManager.java`
- 自定义访问决策逻辑
- 支持动态权限校验

#### 5.4 更新SecurityConfig
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/config/SecurityConfig.java`
- 添加JwtAuthenticationFilter到过滤器链
- 配置AuthenticationManager
- 配置异常处理（401/403）

---

### 阶段六：用户管理API (预计文件数：6)

#### 6.1 DTO类
**文件路径**: `graphrag-common/src/main/java/com/graphrag/common/security/dto/`

| 文件名 | 说明 |
|--------|------|
| UserCreateRequest.java | 创建用户请求 |
| UserUpdateRequest.java | 更新用户请求 |
| UserQueryRequest.java | 用户查询请求 |
| PasswordUpdateRequest.java | 密码更新请求 |

#### 6.2 用户服务
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/service/UserService.java`
- `createUser(UserCreateRequest)` - 创建用户
- `updateUser(Long, UserUpdateRequest)` - 更新用户
- `deleteUser(Long)` - 删除用户
- `getUserById(Long)` - 获取用户详情
- `listUsers(UserQueryRequest)` - 分页查询用户
- `updatePassword(Long, PasswordUpdateRequest)` - 更新密码
- `assignRoles(Long, List<Long>)` - 分配角色

#### 6.3 用户控制器
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/controller/UserController.java`
- `GET /system/user/list` - 用户列表
- `GET /system/user/{id}` - 用户详情
- `POST /system/user` - 创建用户
- `PUT /system/user/{id}` - 更新用户
- `DELETE /system/user/{id}` - 删除用户
- `PUT /system/user/{id}/password` - 修改密码
- `PUT /system/user/{id}/roles` - 分配角色

---

### 阶段七：角色与权限管理API (预计文件数：8)

#### 7.1 角色管理
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/`

| 文件 | 说明 |
|------|------|
| service/RoleService.java | 角色服务 |
| controller/RoleController.java | 角色控制器 |
| dto/RoleCreateRequest.java | 创建角色请求 |
| dto/RoleUpdateRequest.java | 更新角色请求 |

#### 7.2 权限管理
**文件路径**: `graphrag-gateway/src/main/java/com/graphrag/gateway/`

| 文件 | 说明 |
|------|------|
| service/PermissionService.java | 权限服务 |
| controller/PermissionController.java | 权限控制器 |
| dto/PermissionCreateRequest.java | 创建权限请求 |
| dto/PermissionTreeResponse.java | 权限树响应 |

---

### 阶段八：单元测试与集成测试 (预计文件数：10)

#### 8.1 单元测试
**文件路径**: `graphrag-gateway/src/test/java/com/graphrag/gateway/`

| 文件 | 说明 |
|------|------|
| JwtTokenProviderTest.java | JWT工具类测试 |
| AuthServiceTest.java | 认证服务测试 |
| UserServiceTest.java | 用户服务测试 |
| RoleServiceTest.java | 角色服务测试 |
| PermissionServiceTest.java | 权限服务测试 |

#### 8.2 集成测试
**文件路径**: `graphrag-gateway/src/test/java/com/graphrag/gateway/`

| 文件 | 说明 |
|------|------|
| AuthControllerIntegrationTest.java | 认证接口集成测试 |
| UserControllerIntegrationTest.java | 用户接口集成测试 |
| SecurityIntegrationTest.java | 安全集成测试 |
| PermissionAspectTest.java | 权限切面测试 |
| RbacIntegrationTest.java | RBAC集成测试 |

---

## 三、文件清单汇总

| 模块 | 文件数 | 说明 |
|------|--------|------|
| JWT令牌服务 | 4 | JwtProperties, JwtTokenProvider, JwtAuthenticationFilter, TokenService |
| RBAC实体层 | 10 | 5个Entity + 5个Mapper |
| 用户详情服务 | 3 | LoginUser, UserDetailsServiceImpl, UserPermissionCacheService |
| 认证API | 6 | 5个DTO + AuthService + AuthController |
| 权限中间件 | 4 | 2个注解 + PermissionAspect + SecurityConfig更新 |
| 用户管理 | 6 | 4个DTO + UserService + UserController |
| 角色权限管理 | 8 | 4个DTO + RoleService + RoleController + PermissionService + PermissionController |
| 测试 | 10 | 5个单元测试 + 5个集成测试 |
| **总计** | **51** | |

---

## 四、开发顺序

```
Phase 1: JWT令牌服务
    └── JwtProperties → JwtTokenProvider → TokenService → JwtAuthenticationFilter

Phase 2: RBAC实体层
    └── Entity类 → Mapper接口 → Mapper XML

Phase 3: 用户详情服务
    └── LoginUser → UserDetailsServiceImpl → UserPermissionCacheService

Phase 4: 认证API
    └── DTO类 → AuthService → AuthController

Phase 5: 权限中间件
    └── 注解定义 → PermissionAspect → SecurityConfig更新

Phase 6: 用户管理API
    └── DTO类 → UserService → UserController

Phase 7: 角色权限管理API
    └── DTO类 → RoleService → RoleController → PermissionService → PermissionController

Phase 8: 测试
    └── 单元测试 → 集成测试
```

---

## 五、API接口设计

### 5.1 认证接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| POST | /auth/login | 用户登录 | 公开 |
| POST | /auth/register | 用户注册 | 公开 |
| POST | /auth/logout | 用户登出 | 登录 |
| POST | /auth/refresh | 刷新Token | 登录 |
| GET | /auth/me | 当前用户信息 | 登录 |

### 5.2 用户管理接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /system/user/list | 用户列表 | system:user:list |
| GET | /system/user/{id} | 用户详情 | system:user:list |
| POST | /system/user | 创建用户 | system:user:add |
| PUT | /system/user/{id} | 更新用户 | system:user:edit |
| DELETE | /system/user/{id} | 删除用户 | system:user:delete |
| PUT | /system/user/{id}/password | 修改密码 | system:user:edit |
| PUT | /system/user/{id}/roles | 分配角色 | system:user:edit |

### 5.3 角色管理接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /system/role/list | 角色列表 | system:role |
| GET | /system/role/{id} | 角色详情 | system:role |
| POST | /system/role | 创建角色 | system:role |
| PUT | /system/role/{id} | 更新角色 | system:role |
| DELETE | /system/role/{id} | 删除角色 | system:role |
| PUT | /system/role/{id}/permissions | 分配权限 | system:role |

### 5.4 权限管理接口

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /system/permission/list | 权限列表 | system:permission |
| GET | /system/permission/tree | 权限树 | system:permission |
| POST | /system/permission | 创建权限 | system:permission |
| PUT | /system/permission/{id} | 更新权限 | system:permission |
| DELETE | /system/permission/{id} | 删除权限 | system:permission |

---

## 六、安全考虑

### 6.1 JWT安全
- 使用RS256或HS512签名算法
- Token存储在Redis中，支持主动撤销
- Access Token有效期2小时，Refresh Token有效期7天
- Token刷新时生成新的Access Token和Refresh Token

### 6.2 密码安全
- 使用BCrypt加密存储密码
- 密码强度校验（至少8位，包含大小写字母和数字）
- 登录失败次数限制（5次锁定30分钟）

### 6.3 接口安全
- 所有接口默认需要认证
- 白名单接口：登录、注册、刷新Token、Swagger文档
- 敏感操作需要二次验证（可选）

### 6.4 权限控制
- 基于RBAC模型的权限控制
- 支持菜单权限、按钮权限、API权限
- 权限变更实时生效（清除缓存）

---

## 七、依赖关系

```
graphrag-common (公共模块)
    ├── JWT依赖 (jjwt-api, jjwt-impl, jjwt-jackson)
    ├── Spring Security
    └── Spring Web

graphrag-gateway (网关模块)
    ├── graphrag-common
    ├── Spring Security
    ├── Spring Data Redis
    ├── MyBatis Plus
    └── PostgreSQL Driver
```

---

## 八、验收标准

1. **功能验收**
   - [ ] 用户登录返回有效JWT Token
   - [ ] Token过期后自动刷新
   - [ ] 用户登出后Token失效
   - [ ] 无权限访问返回403错误
   - [ ] 未登录访问返回401错误

2. **安全验收**
   - [ ] 密码使用BCrypt加密
   - [ ] Token签名验证通过
   - [ ] SQL注入测试通过
   - [ ] XSS攻击测试通过

3. **性能验收**
   - [ ] 登录接口响应时间 < 200ms
   - [ ] 权限校验响应时间 < 50ms
   - [ ] 支持并发100用户登录

4. **测试验收**
   - [ ] 单元测试覆盖率 > 80%
   - [ ] 集成测试全部通过
   - [ ] 无高危安全漏洞

---

## 九、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| JWT密钥泄露 | 高 | 使用环境变量存储密钥，定期轮换 |
| Redis故障 | 中 | Token降级为本地验证，记录日志 |
| 权限数据不一致 | 中 | 提供权限缓存刷新接口 |
| 并发性能问题 | 中 | 使用Redis缓存，优化SQL查询 |

---

## 十、后续扩展

1. **OAuth2.0集成** - 支持第三方登录（微信、钉钉等）
2. **多因素认证** - 支持短信验证码、TOTP
3. **单点登录(SSO)** - 支持CAS/OIDC协议
4. **审计日志** - 记录用户操作日志
5. **API限流** - 基于用户/IP的限流策略
